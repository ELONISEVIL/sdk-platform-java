on:
  push:
    branches:
    - main
  pull_request:
name: verify_library_generation
jobs:
  verify_library_generation:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        java: [ 11 ]
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-java@v3
      with:
        java-version: ${{ matrix.java }}
        distribution: temurin
        cache: maven
    - name: maven install
      run: |
        mvn install -B -ntp -DskipTests -Dclirr.skip -Dcheckstyle.skip
    - name: clone showcase
      run: |
        git clone https://github.com/googleapis/gapic-showcase.git
    - name: checkout a tag in showcase
      run: |
        # Using hardcoded versions from sdk-platform-java v2.24.0 (showcase references this version)
        git checkout v0.28.2
      working-directory: gapic-showcase
    - name: generate java-aiplatform
      run: |
        # Using hardcoded versions from sdk-platform-java v2.24.0 (showcase references this version)
        GAPIC_GENERATOR_VERSION=2.24.0
        PROTOBUF_VERSION=23.2
        GRPC_VERSION=1.56.1
        bash gapic-generator-java/library-generation/generate_library.sh \
            --proto-location "$(pwd)/gapic-showcase/schema/google/showcase/v1beta1/" \
            --destination-location "$(pwd)/showcase" \
            --gapic-generator-java-version $GAPIC_GENERATOR_VERSION \
            --protobuf-version $PROTOBUF_VERSION \
            --grpc-version $GRPC_VERSION \
            --transport "grpc+rest"
    - name: compare generation result
      run: |
        git diff showcase
      working-directory: sdk-platform-java
